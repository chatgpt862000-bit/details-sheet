<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sahyadri Dairy Farm - Dashboard</title>

<style>
    body {
        font-family: Arial;
        background: #f4f6f9;
        margin: 0; padding: 15px;
    }

    h2, h1 {
        text-align: center;
        margin-bottom: 15px;
    }

    #searchBox {
        width: 95%;
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #aaa;
        margin: auto;
        display: block;
        margin-bottom: 20px;
    }

    .container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 8px #0002;
        position: relative;
    }

    .view-btn {
        background: #2196F3;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
    }

    #popup, #expensePopup {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: #0007;
        justify-content: center;
        align-items: center;
    }

    #popupContent, .expense-box {
        background: white;
        padding: 20px;
        width: 90%;
        max-width: 500px;
        border-radius: 10px;
    }

    #closeBtn, #expenseClose {
        background: red;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        float: right;
        cursor: pointer;
    }

    .field-row { margin-bottom: 6px; }
    .field-label { font-weight: 600; }
</style>
</head>

<body>

<h1>Sahyadri Dairy Farm</h1>
<h2>Cow Details</h2>

<div style="text-align:center; margin-bottom:20px;">
    <button id="expenseBtn"
        style="background:#1E88E5; color:white; border:none;
               padding:12px 20px; border-radius:8px; font-size:16px;
               cursor:pointer;">
        ðŸ“Š View Expenses
    </button>
</div>

<input id="searchBox" placeholder="Search cow, breed, status...">

<div class="container" id="cardContainer"></div>


<!-- Cow Popup -->
<div id="popup">
    <div id="popupContent">
        <button id="closeBtn">Close</button>
        <h3 id="pName"></h3>
        <div id="pDetails"></div>
    </div>
</div>

<!-- Expense Popup -->
<div id="expensePopup">
    <div class="expense-box">
        <button id="expenseClose">Close</button>
        <h3>Expense Summary</h3>

        <div style="margin-bottom:15px;">
            <label><b>Year From:</b></label>
            <select id="yearFrom"></select>

            <label><b>Year To:</b></label>
            <select id="yearTo"></select>

            <label><b>Category:</b></label>
            <select id="expCategory">
                <option value="">All</option>
            </select>
        </div>

        <div id="expenseData"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// -------------------------
// GOOGLE SHEET CSV URLs
// -------------------------

// Cow sheet
const csvUrl =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSFLGioCUdZbAR_v2KaInBD_GVts9csvUr4Mzz6s5_p1YSAcLPPRg16bnO-9s5UKjb_rqECjzMqAGgd/pub?gid=249634938&single=true&output=csv";

// FIXED Expense CSV URL
const expenseCsvUrl =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSFLGioCUdZbAR_v2KaInBD_GVts9csvUr4Mzz6s5_p1YSAcLPPRg16bnO-9s5UKjb_rqECjzMqAGgd/pub?gid=1547099893&single=true&output=csv";



// -------------------------
// DATE HANDLING
// -------------------------
function parseDateFlexible(val) {
    if (!val) return null;
    val = String(val).trim();
    let d = new Date(val);
    if (!isNaN(d)) return d;

    const p = val.includes("/") ? val.split("/") : val.split("-");
    if (p.length === 3) {
        if (p[0].length === 4) return new Date(`${p[0]}-${p[1]}-${p[2]}`);
        return new Date(`${p[2]}-${p[1]}-${p[0]}`);
    }
    return null;
}


// -------------------------
// LOAD COW DATA
// -------------------------
Papa.parse(csvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        renderCards(results.data || []);
    }
});

function renderCards(rows) {
    const container = document.getElementById("cardContainer");
    container.innerHTML = "";

    rows.forEach(row => {
        if (Object.values(row).every(v => !v)) return;

        const card = document.createElement("div");
        card.className = "card";

        const cowName = row["Cow"] || row["Name"] || "Unknown";

        card.innerHTML = `
            <h3>${escapeHtml(cowName)}</h3>
            <p><b>Breed:</b> ${escapeHtml(row["Breed"] || "")}</p>
            <p><b>Status:</b> ${escapeHtml(row["Status"] || "")}</p>
        `;

        const btn = document.createElement("button");
        btn.className = "view-btn";
        btn.innerText = "View Profile";
        btn.onclick = () => showProfile(row);

        card.appendChild(btn);
        container.appendChild(card);
    });
}


// -------------------------
// SHOW COW POPUP
// -------------------------
function showProfile(data) {
    document.getElementById("popup").style.display = "flex";
    document.getElementById("pName").innerText =
        data["Cow"] || data["Name"] || "Unknown";

    let html = "";
    Object.keys(data).forEach(k => {
        html += `<div class="field-row">
            <span class="field-label">${escapeHtml(k)}:</span> ${escapeHtml(data[k])}
        </div>`;
    });

    document.getElementById("pDetails").innerHTML = html;
}

document.getElementById("closeBtn").onclick = () =>
    document.getElementById("popup").style.display = "none";


// -------------------------
// EXPENSE FUNCTIONALITY
// -------------------------
let expenseRows = [];

document.getElementById("expenseBtn").onclick = function () {
    Papa.parse(expenseCsvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            expenseRows = results.data || [];
            prepareExpenseFilters(expenseRows);
            filterAndShowExpenses();
            document.getElementById("expensePopup").style.display = "flex";
        }
    });
};

function prepareExpenseFilters(rows) {
    let years = new Set();
    let categories = new Set();

    rows.forEach(row => {
        const d = parseDateFlexible(row["Date"]);
        if (d) years.add(d.getFullYear());
        if (row["Category"]) categories.add(row["Category"].trim());
    });

    years = [...years].sort();
    categories = [...categories].sort();

    const YF = document.getElementById("yearFrom");
    const YT = document.getElementById("yearTo");
    const CAT = document.getElementById("expCategory");

    YF.innerHTML = "";
    YT.innerHTML = "";

    years.forEach(y => {
        YF.innerHTML += `<option value="${y}">${y}</option>`;
        YT.innerHTML += `<option value="${y}">${y}</option>`;
    });

    if (years.length > 0) {
        YF.value = years[0];
        YT.value = years[years.length - 1];
    }

    CAT.innerHTML = `<option value="">All</option>`;
    categories.forEach(c => {
        CAT.innerHTML += `<option value="${c}">${c}</option>`;
    });

    YF.onchange = filterAndShowExpenses;
    YT.onchange = filterAndShowExpenses;
    CAT.onchange = filterAndShowExpenses;
}

function filterAndShowExpenses() {
    const YF = parseInt(document.getElementById("yearFrom").value);
    const YT = parseInt(document.getElementById("yearTo").value);
    const CAT = document.getElementById("expCategory").value;

    let totals = {};
    let overall = 0;

    expenseRows.forEach(row => {
        const d = parseDateFlexible(row["Date"]);
        if (!d) return;

        let yr = d.getFullYear();
        let cat = (row["Category"] || "").trim();
        let amt = parseFloat(row["Amount"] || row["Rs"] || 0);

        if (!cat || isNaN(amt)) return;

        if (yr < YF || yr > YT) return;
        if (CAT && CAT !== cat) return;

        if (!totals[cat]) totals[cat] = 0;
        totals[cat] += amt;
        overall += amt;
    });

    let html = `
    <table style="width:100%; border-collapse:collapse;">
        <tr style="background:#ddd;">
            <th style="padding:8px; border:1px solid #ccc;">Category</th>
            <th style="padding:8px; border:1px solid #ccc;">Total (Rs)</th>
        </tr>
    `;

    Object.keys(totals).forEach(cat => {
        html += `
        <tr>
            <td style="padding:8px; border:1px solid #ccc;">${cat}</td>
            <td style="padding:8px; border:1px solid #ccc;">${totals[cat].toFixed(2)}</td>
        </tr>`;
    });

    html += `
        <tr style="background:#cfe3ff;">
            <td style="padding:8px; border:1px solid #ccc;"><b>Total</b></td>
            <td style="padding:8px; border:1px solid #ccc;"><b>${overall.toFixed(2)}</b></td>
        </tr>
    `;

    html += "</table>";

    document.getElementById("expenseData").innerHTML = html;
}

document.getElementById("expenseClose").onclick = () =>
    document.getElementById("expensePopup").style.display = "none";


// -------------------------
// SECURITY
// -------------------------
function escapeHtml(str) {
    return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}
</script>

</body>
</html>
